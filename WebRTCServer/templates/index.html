<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Title</title>

    <style>
        #video {
            transform: rotateY(180deg);
            -webkit-transform: rotateY(180deg);
            /* Safari and Chrome */
            -moz-transform: rotateY(180deg);
            /* Firefox */
            visibility: hidden;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>





    <script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.0/socket.io.js'></script>
</head>

<body>

    Start the conversation: <button>Start</button>

    <div id="container">
        <video hidden autoplay playsinline id="videoElement"></video>
        <canvas hidden id="canvas" width="400" height="300"></canvas>
    </div>

    <audio controls>
        <source src="{{ url_for('audio') }}" type="audio/x-wav;codec=pcm">
        Your browser does not support the audio element.
    </audio>


    <!-- 
        <div class='videoReturn'>
            <h1>Video Streaming</h1>
            <img id="photo" width="400" height="300">
        </div>

        using backend to process the image. -->



    <script>
        // $('#camera').css('visibility', 'hidden');

        var socket = io.connect(window.location.protocol + '//' + document.domain + ':' + location.port);
        socket.on('connect', function () {
            console.log("Connected...!", socket.connected)
        });


        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        const video_element = document.querySelector("#videoElement");

        video_element.width = 400;
        video_element.height = 300;


        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function (stream) {

                })
                .catch(function (err0r) {

                });
        }

        const FPS = 20;
        setInterval(() => {
            width = video_element.width;
            height = video_element.height;


            context.drawImage(video_element, 0, 0, width, height);



            var data = canvas.toDataURL('image/jpeg', 0.5);
            // var frame = capture(video_element, 1)
            // var data = frame.toDataURL('image/jpeg', 0.5);

            context.clearRect(0, 0, width, height);
            socket.emit('image', data);
        }, 1000 / FPS);

        socket.on('response_back', function (image) {
            photo.setAttribute('src', image);
        });

        // // Stop video
        // var stream = video.srcObject;
        // var tracks = stream.getTracks();

        // for (var i = 0; i < tracks.length; i++) {
        //     var track = tracks[i];
        //     track.stop();
        // }

        // video.srcObject = null;

    </script>
</body>

</html>